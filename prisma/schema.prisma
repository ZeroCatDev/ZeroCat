generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
  previewFeatures = ["views"]
}

datasource db {
  provider = "postgresql"
  relationMode = "prisma"

}

// 评论表
model ow_comment {
  id         Int       @id @default(autoincrement())
  user_id    Int?
  type       String?   @default("comment") @db.VarChar(64)
  text       String?
  insertedAt DateTime? @default(now()) @db.Timestamp(6)
  user_ip    String?   @default("") @db.VarChar(100)
  link       String?   @db.VarChar(128)
  pid        Int?
  rid        Int?
  status     String    @default("") @db.VarChar(50)
  user_ua    String?
  url        String?   @db.VarChar(255)
  page_type  String?   @db.VarChar(32)
  page_id    String?   @db.VarChar(32)
  createdAt  DateTime? @default(now()) @db.Timestamp(6)
  updatedAt  DateTime? @default(now()) @db.Timestamp(6)
  page_key   String?   @db.VarChar(128)

  // 关联
  user ow_users? @relation(fields: [user_id], references: [id], onDelete: SetNull, onUpdate: SetNull)

  @@index([page_type, page_id, insertedAt])
  @@index([user_id])
  @@map("ow_comment")
}

// 项目表
model ow_projects {
  id             Int       @id @default(autoincrement())
  name           String    @db.VarChar(128)
  default_branch String?   @db.VarChar(128)
  type           String?   @default("text") @db.VarChar(32)
  license        String?   @db.VarChar(32)
  authorid       Int?
  thumbnail      String    @default("") @db.VarChar(37)
  state          String    @default("private") @db.VarChar(32)
  view_count     Int       @default(0)
  like_count     Int       @default(0)
  favo_count     Int       @default(0)
  time           DateTime  @default(now()) @db.Timestamp(6)
  title          String    @default("ZeroCat新项目") @db.VarChar(1000)
  description    String    @default("ZeroCat上的项目") @db.VarChar(1000)
  history        Boolean   @default(true)
  fork           Int?
  star_count     Int       @default(0)

  // 关联
  author            ow_users?                   @relation("ProjectAuthor", fields: [authorid], references: [id], onDelete: SetNull, onUpdate: SetNull)
  stars             ow_projects_stars[]
  lists             ow_projects_list_items[]
  branches          ow_projects_branch[]
  project_tags      ow_projects_tags[]
  extensions        ow_scratch_extensions[]     @relation("ProjectExtensions")
  sample_extensions ow_scratch_extensions[]     @relation("SampleProject")
  assets            ow_projects_assets[]        @relation("ProjectAssets")

  @@index([state])
  @@index([authorid])
  @@index([time(sort: Desc)])
  @@index([name(ops: raw("gin_trgm_ops"))], type: Gin, map: "idx_ow_projects_name_trgm")
  @@index([title(ops: raw("gin_trgm_ops"))], type: Gin, map: "idx_ow_projects_title_trgm")
  @@index([description(ops: raw("gin_trgm_ops"))], type: Gin, map: "idx_ow_projects_description_trgm")
  @@map("ow_projects")
}

// 用户表
model ow_users {
  id               Int       @id @default(autoincrement())
  username         String    @unique @db.VarChar(64)
  email            String?   @db.VarChar(100)
  password         String?   @db.VarChar(255)
  display_name     String    @default("ZeroCat创作者") @db.VarChar(64)
  status           String    @default("active") @db.VarChar(20)

  // 个人资料信息
  motto            String?
  bio              String?
  location         String?   @db.VarChar(100)
  region           String?   @db.VarChar(100)
  birthday         DateTime? @default("2000-03-31T00:00:00.000Z") @db.Timestamp(6)
  sex              String    @default("0") @db.VarChar(16)
  url              String?   @db.VarChar(512)
  custom_status    Json?
  featured_projects Int?

  // 视觉元素
  images  String @default("fcd939e653195bb6d057e8c2519f5cc7") @db.VarChar(512)
  avatar  String @default("fcd939e653195bb6d057e8c2519f5cc7") @db.VarChar(512)

  // 系统字段
  type      String    @default("guest") @db.VarChar(50)
  label     String?   @db.VarChar(255)
  loginTime DateTime? @default(now()) @db.Timestamp(6)
  regTime   DateTime? @default(now()) @db.Timestamp(6)
  createdAt DateTime  @default(now()) @db.Timestamp(6)
  updatedAt DateTime  @updatedAt @db.Timestamp(6)

  // 关联
  auth_tokens             ow_auth_tokens[]
  authored_projects       ow_projects[]           @relation("ProjectAuthor")
  starred_projects        ow_projects_stars[]
  project_lists           ow_projects_lists[]
  contacts                ow_users_contacts[]
  relationships_as_source ow_user_relationships[] @relation("RelationshipSource")
  relationships_as_target ow_user_relationships[] @relation("RelationshipTarget")
  notifications_acted     ow_notifications[]      @relation("NotificationActor")
  events_acted            ow_events[]             @relation("EventActor")
  comments                ow_comment[]
  commits                 ow_projects_commits[]
  oauth_applications      ow_oauth_applications[]
  oauth_authorizations    ow_oauth_authorizations[]
  oauth_access_tokens     ow_oauth_access_tokens[]
  kv_store                ow_cache_kv[]
  account_tokens          ow_account_tokens[]     @relation("AccountTokens")
  uploaded_assets         ow_assets[]             @relation("AssetUploader")
  banned_assets           ow_assets[]             @relation("AssetBannedBy")
  push_subscriptions      ow_push_subscriptions[] @relation("UserPushSubscriptions")
  posts                   ow_posts[]              @relation("PostAuthor")
  likes                   ow_posts_like[]         @relation("LikeAuthor")
  bookmarks               ow_posts_bookmark[]     @relation("BookmarkAuthor")
  mentioned_in_posts      ow_posts_mention[]      @relation("UserMentions")
  comment_spaces          ow_comment_spaces[]     @relation("CommentSpaceOwner")
  comment_service_users   ow_comment_service_users[] @relation("CommentServiceUser")

  @@index([email])
  @@index([status])
  @@index([username(ops: raw("gin_trgm_ops"))], type: Gin, map: "idx_ow_users_username_trgm")
  @@index([display_name(ops: raw("gin_trgm_ops"))], type: Gin, map: "idx_ow_users_display_name_trgm")
  @@index([bio(ops: raw("gin_trgm_ops"))], type: Gin, map: "idx_ow_users_bio_trgm")
  @@index([motto(ops: raw("gin_trgm_ops"))], type: Gin, map: "idx_ow_users_motto_trgm")
  @@index([location(ops: raw("gin_trgm_ops"))], type: Gin, map: "idx_ow_users_location_trgm")
  @@index([region(ops: raw("gin_trgm_ops"))], type: Gin, map: "idx_ow_users_region_trgm")
  @@map("ow_users")
}

// 项目文件表
model ow_projects_file {
  sha256        String    @id @db.VarChar(64)
  source        String?
  create_time   DateTime? @default(now()) @db.Timestamp(6)
  create_userid Int?

  @@index([create_time], map: "idx_ow_projects_file_create_time")
  @@index([create_userid], map: "idx_ow_projects_file_create_userid")
  @@map("ow_projects_file")
}

// 项目历史表
model ow_projects_history {
  id          Int      @id @default(autoincrement())
  authorid    Int
  projectid   Int
  type        String?  @default("text") @db.VarChar(32)
  time        DateTime @default(now()) @db.Timestamp(6)
  title       String   @default("ZeroCat新项目") @db.VarChar(50)
  description String   @default("commit") @db.VarChar(1000)
  source      String?
  state       String   @default("private") @db.VarChar(32)
  licence     String?  @db.VarChar(45)
  tags        String?  @db.VarChar(100)

  @@index([projectid])
  @@index([authorid])
  @@map("ow_projects_history")
}

// 配置类型枚举
enum ow_config_type {
  STRING
  NUMBER
  BOOLEAN
  ARRAY
  ENUM
}

// 配置表
model ow_config {
  id         Int            @id @default(autoincrement())
  key        String         @unique @db.VarChar(255)
  value      String
  type       ow_config_type @default(STRING)
  metadata   Json?
  created_at DateTime       @default(now()) @db.Timestamp(6)
  updated_at DateTime       @default(now()) @db.Timestamp(6)

  @@map("ow_config")
}

// 用户TOTP表
model ow_users_totp {
  id                Int       @id @default(autoincrement())
  name              String    @default("验证器") @db.VarChar(128)
  user_id           Int
  type              String    @default("totp") @db.VarChar(45)
  status            String    @default("unverified") @db.VarChar(32)
  totp_secret       String?   @db.VarChar(255)
  totp_algorithm    String    @default("SHA256") @db.VarChar(10)
  totp_digits       Int       @default(6)
  totp_period       Int       @default(30)
  totp_last_updated DateTime? @db.Timestamp(6)
  created_at        DateTime  @default(now()) @db.Timestamp(6)
  updated_at        DateTime  @default(now()) @db.Timestamp(6)

  @@index([user_id])
  @@map("ow_users_totp")
}

// 项目标签表
model ow_projects_tags {
  id         Int      @id @default(autoincrement())
  name       String   @db.VarChar(45)
  projectid  Int?
  created_at DateTime @default(now()) @db.Timestamp(6)

  // 关联
  project ow_projects? @relation(fields: [projectid], references: [id], onDelete: SetNull, onUpdate: SetNull)

  @@index([projectid])
  @@index([name])
  @@map("ow_projects_tags")
}

// 项目收藏表
model ow_projects_stars {
  id         Int      @id @default(autoincrement())
  userid     Int?
  projectid  Int?
  createTime DateTime @default(now()) @db.Timestamp(6)

  // 关联
  user    ow_users?    @relation(fields: [userid], references: [id], onDelete: SetNull, onUpdate: SetNull)
  project ow_projects? @relation(fields: [projectid], references: [id], onDelete: SetNull, onUpdate: SetNull)

  @@unique([userid, projectid])
  @@index([projectid])
  @@index([userid])
  @@map("ow_projects_stars")
}

// 项目列表表
model ow_projects_lists {
  id          Int       @id @default(autoincrement())
  authorid    Int?
  title       String    @default("收藏夹") @db.VarChar(1024)
  description String    @default("列表") @db.VarChar(1024)
  state       String    @default("private") @db.VarChar(32)
  list        String?
  updateTime  DateTime? @db.Timestamp(6)
  createTime  DateTime  @default(now()) @db.Timestamp(6)

  // 关联
  author     ow_users?                @relation(fields: [authorid], references: [id], onDelete: SetNull, onUpdate: SetNull)
  list_items ow_projects_list_items[]

  @@index([authorid])
  @@map("ow_projects_lists")
}

// 项目提交表
model ow_projects_commits {
  id                 String   @id @db.VarChar(256)
  project_id         Int
  author_id          Int?
  branch             String   @default("main") @db.VarChar(255)
  parent_commit_id   String?  @db.VarChar(256)
  commit_message     String
  commit_date        DateTime @db.Timestamp(6)
  commit_file        String   @db.VarChar(256)
  commit_description String?
  depth              Int?

  // 关联
  parent_commit ow_projects_commits?  @relation("CommitTree", fields: [parent_commit_id], references: [id], onDelete: Restrict, onUpdate: Restrict)
  child_commits ow_projects_commits[] @relation("CommitTree")
  author        ow_users?             @relation(fields: [author_id], references: [id], onDelete: SetNull, onUpdate: SetNull)

  @@index([project_id, commit_date(sort: Desc)])
  @@index([parent_commit_id])
  @@index([author_id])
  @@map("ow_projects_commits")
}

// 魔法链接表
model ow_users_magiclink {
  id        Int      @id @default(autoincrement())
  userId    Int
  token     String   @unique @db.VarChar(255)
  expiresAt DateTime @db.Timestamp(6)

  @@index([expiresAt])
  @@map("ow_users_magiclink")
}

// 项目分支表
model ow_projects_branch {
  id                 Int         @id @default(autoincrement())
  name               String      @db.VarChar(128)
  latest_commit_hash String      @db.VarChar(64)
  description        String      @db.VarChar(128)
  projectid          Int?
  protected          Boolean     @default(false)
  creator            Int?

  // 关联
  project ow_projects? @relation(fields: [projectid], references: [id], onDelete: SetNull, onUpdate: SetNull)

  @@unique([projectid, name])
  @@index([creator])
  @@map("ow_projects_branch")
}



// 用户联系方式表
model ow_users_contacts {
  contact_id    Int                             @id @default(autoincrement())
  user_id       Int?
  contact_value String                          @unique @db.VarChar(255)
  contact_info  String?                         @db.VarChar(255)
  contact_type  String                          @db.VarChar(50)
  is_primary    Boolean                         @default(false)
  verified      Boolean                         @default(false)
  metadata      Json?
  created_at    DateTime                        @default(now()) @db.Timestamp(6)
  updated_at    DateTime                        @default(now()) @db.Timestamp(6)

  // 关联
  user ow_users? @relation(fields: [user_id], references: [id], onDelete: SetNull, onUpdate: SetNull)

  @@index([user_id])
  @@index([user_id, contact_type])
  @@map("ow_users_contacts")
}

// 事件表
model ow_events {
  id          Int      @id @default(autoincrement())
  event_type  String   @db.VarChar(50)
  actor_id    Int?
  target_type String   @db.VarChar(50)
  target_id   Int
  event_data  Json
  created_at  DateTime @default(now()) @db.Timestamp(6)
  public      Boolean  @default(false)

  // 关联
  actor ow_users? @relation("EventActor", fields: [actor_id], references: [id], onDelete: SetNull, onUpdate: SetNull)

  @@index([created_at(sort: Desc)])
  @@index([target_type, target_id])
  @@index([event_type, actor_id])
  @@map("ow_events")
}

// 项目列表项表
model ow_projects_list_items {
  id         Int      @id @default(autoincrement())
  listid     Int?
  projectid  Int?
  createTime DateTime @default(now()) @db.Timestamp(6)

  // 关联
  list    ow_projects_lists? @relation(fields: [listid], references: [id], onDelete: SetNull, onUpdate: SetNull)
  project ow_projects?       @relation(fields: [projectid], references: [id], onDelete: SetNull, onUpdate: SetNull)

  @@unique([listid, projectid])
  @@index([listid])
  @@index([projectid])
  @@map("ow_projects_list_items")
}

// 认证令牌表
model ow_auth_tokens {
  id                 Int       @id @default(autoincrement())
  user_id            Int?
  access_token       String    @unique @db.VarChar(255)
  refresh_token      String    @unique @db.VarChar(255)
  expires_at         DateTime  @db.Timestamp(6)
  refresh_expires_at DateTime  @db.Timestamp(6)
  created_at         DateTime  @default(now()) @db.Timestamp(6)
  updated_at         DateTime  @updatedAt @db.Timestamp(6)
  last_used_at       DateTime? @db.Timestamp(6)
  last_used_ip       String?   @db.VarChar(255)
  activity_count     Int       @default(0)
  extended_at        DateTime? @db.Timestamp(6)
  revoked            Boolean   @default(false)
  revoked_at         DateTime? @db.Timestamp(6)
  ip_address         String?   @db.VarChar(100)
  user_agent         String?
  device_info        String?

  // 关联
  user ow_users? @relation(fields: [user_id], references: [id], onDelete: SetNull, onUpdate: SetNull)

  @@index([user_id])
  @@index([last_used_at])
  @@index([last_used_ip])
  @@index([expires_at])
  @@map("ow_auth_tokens")
}

// 通知表
model ow_notifications {
  id                Int       @id @default(autoincrement())
  user_id           Int
  title             String?   @db.VarChar(100)
  content           String?
  link              String?   @db.VarChar(255)
  metadata          Json?
  notification_type String    @db.VarChar(64)
  read              Boolean   @default(false)
  high_priority     Boolean   @default(false)
  hidden            Boolean   @default(false)
  push_channels     Json?
  push_results      Json?
  push_error        Boolean   @default(false)
  created_at        DateTime  @default(now()) @db.Timestamp(6)
  read_at           DateTime? @db.Timestamp(6)
  actor_id          Int?
  target_type       String?   @db.VarChar(50)
  target_id         Int?
  data              Json?

  // 关联
  actor ow_users? @relation("NotificationActor", fields: [actor_id], references: [id], onDelete: SetNull, onUpdate: SetNull)

  @@index([user_id, read, created_at(sort: Desc)])
  @@index([user_id, created_at(sort: Desc)])
  @@index([actor_id])
  @@index([hidden])
  @@map("ow_notifications")
}

// 用户关系类型枚举
enum ow_user_relationship_type {
  follow
  block
  mute
  favorite
}

// 用户关系表
model ow_user_relationships {
  id                Int                       @id @default(autoincrement())
  source_user_id    Int?
  target_user_id    Int?
  relationship_type ow_user_relationship_type
  created_at        DateTime                  @default(now()) @db.Timestamp(6)
  updated_at        DateTime                  @updatedAt @db.Timestamp(6)
  metadata          Json?

  // 关联
  source_user ow_users? @relation("RelationshipSource", fields: [source_user_id], references: [id], onDelete: SetNull, onUpdate: SetNull)
  target_user ow_users? @relation("RelationshipTarget", fields: [target_user_id], references: [id], onDelete: SetNull, onUpdate: SetNull)

  @@unique([source_user_id, target_user_id, relationship_type])
  @@index([source_user_id, relationship_type])
  @@index([target_user_id, relationship_type])
  @@map("ow_user_relationships")
}

// 分析设备表
model ow_analytics_device {
  id             Int      @id @default(autoincrement())
  fingerprint    String   @db.VarChar(255)
  user_id        Int?
  hostname       String?  @db.VarChar(255)
  screen         String?  @db.VarChar(50)
  language       String?  @db.VarChar(20)
  browser        String?  @db.VarChar(100)
  browser_version String? @db.VarChar(50)
  os             String?  @db.VarChar(100)
  os_version     String?  @db.VarChar(50)
  device_type    String?  @db.VarChar(20)
  device_vendor  String?  @db.VarChar(100)
  user_agent     String?
  first_seen     DateTime @default(now()) @db.Timestamp(6)
  last_seen      DateTime @default(now()) @db.Timestamp(6)

  // 关联
  events ow_analytics_event[]

  @@unique([fingerprint, user_id])
  @@index([user_id])
  @@index([first_seen])
  @@index([last_seen])
  @@map("ow_analytics_device")
}

// 分析事件表
model ow_analytics_event {
  id              Int      @id @default(autoincrement())
  device_id       Int?
  user_id         Int?
  url             String   @db.VarChar(2048)
  url_path        String   @db.VarChar(1024)
  url_query       String?  @db.VarChar(1024)
  referrer        String?  @db.VarChar(2048)
  referrer_domain String?  @db.VarChar(255)
  referrer_path   String?  @db.VarChar(1024)
  referrer_query  String?  @db.VarChar(1024)
  page_title      String?  @db.VarChar(500)
  target_type     String   @db.VarChar(50)
  target_id       Int
  ip_address      String?  @db.VarChar(100)
  country         String?  @db.VarChar(100)
  region          String?  @db.VarChar(100)
  city            String?  @db.VarChar(100)
  timezone        String?  @db.VarChar(100)
  created_at      DateTime @default(now()) @db.Timestamp(6)

  // 关联
  device ow_analytics_device? @relation(fields: [device_id], references: [id], onDelete: SetNull, onUpdate: SetNull)

  @@index([device_id])
  @@index([user_id])
  @@index([created_at(sort: Desc)])
  @@index([referrer_domain])
  @@index([ip_address])
  @@index([target_type, target_id])
  @@map("ow_analytics_event")
}

// OAuth应用表
model ow_oauth_applications {
  id             Int      @id @default(autoincrement())
  owner_id       Int?
  name           String   @db.VarChar(255)
  description    String?
  homepage_url   String?  @db.VarChar(500)
  client_id      String   @unique @db.VarChar(255)
  client_secret  String   @db.VarChar(255)
  redirect_uris  Json
  type           String   @default("oauth") @db.VarChar(50)
  client_type    String   @default("confidential") @db.VarChar(50)
  scopes         Json
  webhook_url    String?  @db.VarChar(500)
  logo_url       String?  @db.VarChar(500)
  terms_url      String?  @db.VarChar(500)
  privacy_url    String?  @db.VarChar(500)
  status         String   @default("active") @db.VarChar(50)
  is_verified    Boolean  @default(false)
  is_public      Boolean  @default(false)
  created_at     DateTime @default(now()) @db.Timestamp(6)
  updated_at     DateTime @updatedAt @db.Timestamp(6)

  // 关联
  owner          ow_users?                 @relation(fields: [owner_id], references: [id], onDelete: SetNull, onUpdate: SetNull)
  authorizations ow_oauth_authorizations[]
  access_tokens  ow_oauth_access_tokens[]

  @@index([owner_id])
  @@index([client_id])
  @@index([status])
  @@map("oauth_applications")
}

// OAuth授权记录表
model ow_oauth_authorizations {
  id                     Int       @id @default(autoincrement())
  application_id         Int?
  user_id                Int?
  authorized_email       String    @db.VarChar(255)
  scopes                 Json
  code                   String?   @unique @db.VarChar(255)
  code_challenge         String?   @db.VarChar(255)
  code_challenge_method  String?   @db.VarChar(20)
  code_expires_at        DateTime? @db.Timestamp(6)
  status                 String    @default("active") @db.VarChar(50)
  last_used_at           DateTime? @db.Timestamp(6)
  metadata               Json?
  created_at             DateTime  @default(now()) @db.Timestamp(6)
  updated_at             DateTime  @updatedAt @db.Timestamp(6)

  // 关联
  application   ow_oauth_applications?   @relation(fields: [application_id], references: [id], onDelete: SetNull, onUpdate: SetNull)
  user          ow_users?                @relation(fields: [user_id], references: [id], onDelete: SetNull, onUpdate: SetNull)
  access_tokens ow_oauth_access_tokens[]

  @@unique([application_id, user_id])
  @@index([code])
  @@index([user_id])
  @@map("oauth_authorizations")
}

// OAuth访问令牌表
model ow_oauth_access_tokens {
  id                       Int       @id @default(autoincrement())
  application_id           Int?
  authorization_id         Int?
  user_id                  Int?
  access_token             String    @unique @db.VarChar(255)
  refresh_token            String?   @unique @db.VarChar(255)
  scopes                   Json
  expires_at               DateTime  @db.Timestamp(6)
  refresh_token_expires_at DateTime? @db.Timestamp(6)
  ip_address               String?   @db.VarChar(100)
  user_agent               String?
  last_used_at             DateTime? @db.Timestamp(6)
  last_used_ip             String?   @db.VarChar(100)
  is_revoked               Boolean   @default(false)
  created_at               DateTime  @default(now()) @db.Timestamp(6)
  updated_at               DateTime  @updatedAt @db.Timestamp(6)

  // 关联
  application   ow_oauth_applications?   @relation(fields: [application_id], references: [id], onDelete: SetNull, onUpdate: SetNull)
  authorization ow_oauth_authorizations? @relation(fields: [authorization_id], references: [id], onDelete: SetNull, onUpdate: SetNull)
  user          ow_users?                @relation(fields: [user_id], references: [id], onDelete: SetNull, onUpdate: SetNull)

  @@index([access_token])
  @@index([refresh_token])
  @@index([user_id])
  @@index([application_id])
  @@index([authorization_id])
  @@index([expires_at])
  @@map("oauth_access_tokens")
}

// OAuth权限表
model ow_oauth_scopes {
  id                    Int      @id @default(autoincrement())
  name                  String   @unique @db.VarChar(100)
  description           String
  is_default            Boolean  @default(false)
  requires_verification Boolean  @default(false)
  category              String   @db.VarChar(50)
  risk_level            String   @default("low") @db.VarChar(20)
  created_at            DateTime @default(now()) @db.Timestamp(6)
  updated_at            DateTime @updatedAt @db.Timestamp(6)

  @@index([category])
  @@index([risk_level])
  @@map("oauth_scopes")
}

// 用户键值存储表
model ow_cache_kv {
  user_id    Int      @db.Integer
  key        String   @db.VarChar(255)
  value      Json
  creator_ip String   @default("") @db.VarChar(100)
  created_at DateTime @default(now()) @db.Timestamp(6)
  updated_at DateTime @updatedAt @db.Timestamp(6)

  // 关联
  user ow_users @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@id([user_id, key])
  @@index([user_id])
  @@index([key])
  @@map("ow_cache_kv")
}

// 通用目标配置表（无关联，按 target_type + target_id + key 存储）
model ow_target_configs {
  id          Int      @id @default(autoincrement())
  target_type String   @db.VarChar(64)
  target_id   String   @db.VarChar(64)
  key         String   @db.VarChar(255)
  value       String   @db.Text
  created_at  DateTime @default(now()) @db.Timestamp(6)
  updated_at  DateTime @updatedAt @db.Timestamp(6)

  @@unique([target_type, target_id, key])
  @@index([target_type, target_id])
  @@index([key])
  @@map("project_config")
}

// 云变量修改历史
model project_clouddata_history {
  id                  Int      @id @default(autoincrement())
  project_id          Int
  method              String   @db.VarChar(32)
  name                String   @db.VarChar(1024)
  value               String?  @db.Text
  actor_id            Int?
  actor_name          String?  @db.VarChar(255)
  ip                  String?  @db.VarChar(100)
  created_at          DateTime @default(now()) @db.Timestamp(6)

  @@index([project_id, created_at(sort: Desc)])
  @@index([method])
  @@index([actor_id])
  @@map("project_clouddata_history")
}

// 代码运行设备表
model ow_coderun_devices {
  id            String   @id @default(uuid()) @db.Uuid
  device_name   String   @db.VarChar(255)
  runner_token  String   @unique @db.VarChar(255)
  request_url   String?  @db.VarChar(1024)
  status        String   @default("active") @db.VarChar(32)
  device_config Json?
  created_at    DateTime @default(now()) @db.Timestamp(6)
  updated_at    DateTime @updatedAt @db.Timestamp(6)

  @@index([status])
  @@index([runner_token])
  @@map("ow_coderun_devices")
}

// Scratch扩展表
model ow_scratch_extensions {
  id                Int      @id @default(autoincrement())
  projectid         Int?
  branch            String   @default("") @db.VarChar(128)
  commit            String   @default("latest") @db.VarChar(64)
  image             String   @db.VarChar(255)
  samples           Int?
  docs              String?  @db.VarChar(1024)
  scratchCompatible Boolean  @default(false)
  status            String   @default("developing") @db.VarChar(32)
  created_at        DateTime @default(now()) @db.Timestamp(6)
  updated_at        DateTime @updatedAt @db.Timestamp(6)

  // 关联
  project        ow_projects?  @relation("ProjectExtensions", fields: [projectid], references: [id], onDelete: SetNull, onUpdate: SetNull)
  sample_project ow_projects? @relation("SampleProject", fields: [samples], references: [id], onDelete: SetNull, onUpdate: SetNull)

  @@unique([projectid])
  @@index([projectid])
  @@index([status])
  @@index([samples])
  @@map("ow_scratch_extensions")
}

// 用户账户令牌表
model ow_account_tokens {
  id           Int       @id @default(autoincrement())
  user_id      Int?
  name         String    @db.VarChar(255)
  token        String    @unique @db.VarChar(255)
  expires_at   DateTime? @db.Timestamp(6)
  is_revoked   Boolean   @default(false)
  revoked_at   DateTime? @db.Timestamp(6)
  last_used_at DateTime? @db.Timestamp(6)
  last_used_ip String?   @db.VarChar(100)
  created_at   DateTime  @default(now()) @db.Timestamp(6)
  updated_at   DateTime  @updatedAt @db.Timestamp(6)

  // 关联
  user ow_users? @relation("AccountTokens", fields: [user_id], references: [id], onDelete: SetNull, onUpdate: SetNull)

  @@index([user_id])
  @@index([token])
  @@index([is_revoked])
  @@index([expires_at])
  @@map("ow_account_tokens")
}

// 项目素材关联表
model ow_projects_assets {
  id            Int      @id @default(autoincrement())
  project_id    Int?
  asset_id      Int?
  usage_context String?  @db.VarChar(255)
  usage_order   Int      @default(0)
  created_at    DateTime @default(now()) @db.Timestamp(6)
  updated_at    DateTime @updatedAt @db.Timestamp(6)

  // 关联
  project ow_projects? @relation("ProjectAssets", fields: [project_id], references: [id], onDelete: SetNull, onUpdate: SetNull)
  asset   ow_assets?   @relation("AssetProjects", fields: [asset_id], references: [id], onDelete: SetNull, onUpdate: SetNull)

  @@unique([project_id, asset_id])
  @@index([project_id])
  @@index([asset_id])
  @@index([usage_context])
  @@map("ow_projects_assets")
}

// 素材管理表
model ow_assets {
  id            Int       @id @default(autoincrement())
  md5           String    @unique @db.VarChar(32)
  filename      String    @db.VarChar(255)
  extension     String    @db.VarChar(20)
  mime_type     String    @db.VarChar(100)
  file_size     Int
  uploader_id   Int?
  uploader_ip   String?   @db.VarChar(100)
  uploader_ua   String?
  created_at    DateTime  @default(now()) @db.Timestamp(6)
  updated_at    DateTime  @updatedAt @db.Timestamp(6)
  is_banned     Boolean   @default(false)
  banned_at     DateTime? @db.Timestamp(6)
  banned_by     Int?
  ban_reason    String?   @db.VarChar(500)
  usage_count   Int       @default(0)
  last_used_at  DateTime? @db.Timestamp(6)
  metadata      Json?
  tags          String?   @db.VarChar(500)
  category      String?   @db.VarChar(50)

  // 关联
  uploader       ow_users?            @relation("AssetUploader", fields: [uploader_id], references: [id], onDelete: SetNull, onUpdate: SetNull)
  banned_by_user ow_users?            @relation("AssetBannedBy", fields: [banned_by], references: [id], onDelete: SetNull, onUpdate: SetNull)
  projects       ow_projects_assets[] @relation("AssetProjects")
  post_media     ow_posts_media[]

  @@index([md5])
  @@index([uploader_id])
  @@index([created_at(sort: Desc)])
  @@index([is_banned])
  @@index([extension])
  @@index([category])
  @@index([usage_count])
  @@map("ow_assets")
}

// 浏览器通知订阅表
model ow_push_subscriptions {
  id           Int       @id @default(autoincrement())
  user_id      Int?
  endpoint     String    @db.VarChar(500)
  p256dh_key   String    @db.VarChar(255)
  auth_key     String    @db.VarChar(255)
  user_agent   String?
  device_info  Json?
  is_active    Boolean   @default(true)
  last_used_at DateTime? @db.Timestamp(6)
  created_at   DateTime  @default(now()) @db.Timestamp(6)
  updated_at   DateTime  @updatedAt @db.Timestamp(6)

  // 关联
  user ow_users? @relation("UserPushSubscriptions", fields: [user_id], references: [id], onDelete: SetNull, onUpdate: SetNull)

  @@unique([user_id, endpoint])
  @@index([user_id])
  @@index([is_active])
  @@index([last_used_at])
  @@map("ow_push_subscriptions")
}

// 推文类型枚举
enum ow_post_type {
  normal
  reply
  retweet
  quote
}

// 推文表 - Twitter-like posts (包含转推/引用/回复)
model ow_posts {
  id                Int       @id @default(autoincrement())
  author_id         Int
  post_type         ow_post_type @default(normal)
  content           String?   @db.Text
  character_count   Int       @default(0) // 字符数（用于280字符限制检查）
  in_reply_to_id    Int?      // 回复指向
  thread_root_id    Int?      // 线程根推文
  quoted_post_id    Int?      // 引用推文指向
  retweet_post_id   Int?      // 转推指向
  reply_count       Int       @default(0)
  retweet_count     Int       @default(0)
  like_count        Int       @default(0)
  bookmark_count    Int       @default(0)
  is_deleted        Boolean   @default(false)
  embed             Json?     // 嵌入资源 { type: 'project'|'list'|'user', id, ...其他参数 }
  platform_refs     Json?     // 各平台关联ID映射 { bluesky: { uri, cid }, twitter: { id } }
  created_at        DateTime  @default(now()) @db.Timestamp(6)
  updated_at        DateTime  @updatedAt @db.Timestamp(6)
  metadata          Json?     // 存储额外的元数据

  // 关联
  author        ow_users? @relation("PostAuthor", fields: [author_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  in_reply_to   ow_posts? @relation("PostReplies", fields: [in_reply_to_id], references: [id], onDelete: Restrict, onUpdate: Restrict)
  replies       ow_posts[] @relation("PostReplies")
  thread_root   ow_posts? @relation("PostThreads", fields: [thread_root_id], references: [id], onDelete: Restrict, onUpdate: Restrict)
  thread_posts  ow_posts[] @relation("PostThreads")
  quoted_post   ow_posts? @relation("PostQuotes", fields: [quoted_post_id], references: [id], onDelete: Restrict, onUpdate: Restrict)
  quoted_by     ow_posts[] @relation("PostQuotes")
  retweet_post  ow_posts? @relation("PostRetweets", fields: [retweet_post_id], references: [id], onDelete: Restrict, onUpdate: Restrict)
  retweeted_by  ow_posts[] @relation("PostRetweets")
  likes         ow_posts_like[]
  bookmarks     ow_posts_bookmark[]
  post_media    ow_posts_media[]
  mentions      ow_posts_mention[]

  @@index([author_id, created_at(sort: Desc)])
  @@index([created_at(sort: Desc)])
  @@index([in_reply_to_id])
  @@index([thread_root_id])
  @@index([quoted_post_id])
  @@index([retweet_post_id])
  @@index([post_type])
  @@index([is_deleted])
  @@index([is_deleted, created_at(sort: Desc)])
  @@index([thread_root_id, created_at(sort: Asc)])
  @@index([content(ops: raw("gin_trgm_ops"))], type: Gin, map: "idx_ow_posts_content_trgm")
  @@map("ow_posts")
}

// 提及用户关联表 - Mentions
model ow_posts_mention {
  id         Int       @id @default(autoincrement())
  post_id    Int
  user_id    Int
  created_at DateTime  @default(now()) @db.Timestamp(6)
  notified   Boolean   @default(false)

  // 关联
  post ow_posts @relation(fields: [post_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  user ow_users @relation("UserMentions", fields: [user_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@unique([post_id, user_id])
  @@index([user_id, created_at(sort: Desc)])
  @@index([post_id])
  @@map("ow_posts_mention")
}

// 点赞表 - Likes
model ow_posts_like {
  id         Int       @id @default(autoincrement())
  user_id    Int
  post_id    Int
  created_at DateTime  @default(now()) @db.Timestamp(6)

  // 关联
  user ow_users? @relation("LikeAuthor", fields: [user_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  post ow_posts  @relation(fields: [post_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@unique([user_id, post_id])
  @@index([user_id, created_at(sort: Desc)])
  @@index([post_id])
  @@map("ow_posts_like")
}

// 收藏表 - Bookmarks
model ow_posts_bookmark {
  id         Int       @id @default(autoincrement())
  user_id    Int
  post_id    Int
  created_at DateTime  @default(now()) @db.Timestamp(6)

  // 关联
  user ow_users? @relation("BookmarkAuthor", fields: [user_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  post ow_posts  @relation(fields: [post_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@unique([user_id, post_id])
  @@index([user_id, created_at(sort: Desc)])
  @@index([post_id])
  @@map("ow_posts_bookmark")
}

// 推文媒体关联表 - Post media
model ow_posts_media {
  id         Int       @id @default(autoincrement())
  post_id    Int
  asset_id   Int?
  order      Int       @default(0) // 媒体顺序
  created_at DateTime  @default(now()) @db.Timestamp(6)

  // 关联
  post  ow_posts  @relation(fields: [post_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  asset ow_assets? @relation(fields: [asset_id], references: [id], onDelete: SetNull, onUpdate: SetNull)

  @@unique([post_id, asset_id])
  @@unique([post_id, order])
  @@index([post_id])
  @@index([asset_id])
  @@map("ow_posts_media")
}

// 评论空间表
model ow_comment_spaces {
  id          Int       @id @default(autoincrement())
  cuid        String    @unique @db.VarChar(32)
  owner_id    Int
  name        String    @db.VarChar(128)
  domain      String?   @db.VarChar(255)
  status      String    @default("active") @db.VarChar(32)
  jwt_secret  String    @db.VarChar(255)
  created_at  DateTime  @default(now()) @db.Timestamp(6)
  updated_at  DateTime  @updatedAt @db.Timestamp(6)

  owner       ow_users  @relation("CommentSpaceOwner", fields: [owner_id], references: [id], onDelete: Cascade)
  comments    ow_comment_service[]
  users       ow_comment_service_users[]
  counters    ow_comment_service_counter[]

  @@index([owner_id])
  @@index([status])
  @@map("ow_comment_spaces")
}

// SaaS评论表
model ow_comment_service {
  id          Int       @id @default(autoincrement())
  space_id    Int
  user_id     String?   @db.VarChar(64)
  nick        String?   @db.VarChar(128)
  mail        String?   @db.VarChar(255)
  link        String?   @db.VarChar(255)
  comment     String    @db.Text
  url         String    @db.VarChar(1024)
  ua          String?   @db.Text
  ip          String?   @db.VarChar(100)
  status      String    @default("approved") @db.VarChar(32)
  pid         String?   @db.VarChar(64)
  rid         String?   @db.VarChar(64)
  like        Int       @default(0)
  sticky      Boolean   @default(false)
  insertedAt  DateTime  @default(now()) @db.Timestamp(6)
  createdAt   DateTime  @default(now()) @db.Timestamp(6)
  updatedAt   DateTime  @updatedAt @db.Timestamp(6)

  space       ow_comment_spaces @relation(fields: [space_id], references: [id], onDelete: Cascade)

  @@index([space_id, url, status])
  @@index([space_id, insertedAt(sort: Desc)])
  @@index([space_id, rid])
  @@index([space_id, user_id])
  @@index([space_id, ip])
  @@index([comment(ops: raw("gin_trgm_ops"))], type: Gin, map: "idx_ow_comment_service_comment_trgm")
  @@map("ow_comment_service")
}

// 空间用户映射表
model ow_comment_service_users {
  id            Int       @id @default(autoincrement())
  space_id      Int
  user_id       Int
  type          String    @default("guest") @db.VarChar(32)
  display_name  String?   @db.VarChar(128)
  email         String?   @db.VarChar(255)
  url           String?   @db.VarChar(255)
  avatar        String?   @db.VarChar(255)
  label         String?   @db.VarChar(255)
  created_at    DateTime  @default(now()) @db.Timestamp(6)
  updated_at    DateTime  @updatedAt @db.Timestamp(6)

  space         ow_comment_spaces @relation(fields: [space_id], references: [id], onDelete: Cascade)
  user          ow_users @relation("CommentServiceUser", fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([space_id, user_id])
  @@index([space_id])
  @@index([user_id])
  @@map("ow_comment_service_users")
}

// 页面计数器表
model ow_comment_service_counter {
  id          Int       @id @default(autoincrement())
  space_id    Int
  url         String    @db.VarChar(1024)
  time        Int       @default(0)
  reaction0   Int       @default(0)
  reaction1   Int       @default(0)
  reaction2   Int       @default(0)
  reaction3   Int       @default(0)
  reaction4   Int       @default(0)
  reaction5   Int       @default(0)
  reaction6   Int       @default(0)
  reaction7   Int       @default(0)
  reaction8   Int       @default(0)
  created_at  DateTime  @default(now()) @db.Timestamp(6)
  updated_at  DateTime  @updatedAt @db.Timestamp(6)

  space       ow_comment_spaces @relation(fields: [space_id], references: [id], onDelete: Cascade)

  @@unique([space_id, url])
  @@index([space_id])
  @@map("ow_comment_service_counter")
}
