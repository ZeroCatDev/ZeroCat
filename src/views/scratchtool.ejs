var htmlElement = document.getElementsByTagName("html")[0];

// Configuration management
const ZCConfig = {
  frontend: {
    url: "<%= global.config['urls.frontend'] %>",
    getPath: function (path) {
      return `${this.url}${path}`;
    },
  },
  api: {
    url: "<%= global.config['urls.backend'] %>",
    getPath: function (path) {
      return `${this.url}${path}`;
    },
  },
  s3: {
    staticUrl: "<%= global.config['s3.staticurl'] %>",
  },
};

// --- Refactored Application Management & Resource Loading ---
const App = {
  initialize: async function () {
    try {
      loadStyle(ZCConfig.frontend.getPath("/scratchtool/mdui.css"));
      await this.loadScript(ZCConfig.frontend.getPath("/scratchtool/jquery.3.7.1.js"));
      await this.loadScript(ZCConfig.frontend.getPath("/scratchtool/mdui.global.js"));

      $(document).ready(() => {
        initUIComponents();
        initialize(); // This is the main application logic initialization
      });
    } catch (error) {
      console.error("Application initialization failed:", error);
      alert(`应用初始化失败: ${error.message}`);
    }
  },

  loadScript: (src) => {
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = src;
      script.onload = () => resolve();
      script.onerror = () => reject(new Error(`Script load error for ${src}`));
      document.head.appendChild(script);
    });
  },
};

const loadStyle = (href) => {
  const link = document.createElement("link");
  link.rel = "stylesheet";
  link.href = href;
  document.head.appendChild(link);
};

window.onload = () => {
  App.initialize();
};


// 将依赖mdui的UI操作封装到这个函数中
function initUIComponents() {
  htmlElement.classList.add("mdui-theme-dark");
  mdui.setColorScheme("#2087fd");
  window.UIManager = {
    showSnackbar: function (message) {
      mdui.snackbar({ message, closeable: true });
    },
    showAlert: function (options) {
      mdui.alert(options);
    },
  };
}

// 令牌管理工具
const TokenManager = {
  // 获取当前令牌
  getToken: function () {
    return localStorage.getItem("token");
  },

  // 保存令牌信息
  saveTokens: function (accessToken, refreshToken) {
    localStorage.setItem("token", accessToken);
    if (refreshToken) {
      localStorage.setItem("refreshToken", refreshToken);
    }
  },
};


// Description: ZeroCat Scratch Tool
let zcvm, zcgui;
let _pid = 0;
let logText,
  zctab,
  cloudDialog,
  cloudProjectIdInput,
  cloudUsernameInput,
  cloudConnStatusInput,
  cloudVarsCountInput,
  cloudVarsListContainer,
  cloudSyncTimer = null,
  currentUserId = null,  // 当前用户ID，由后端API获取
  projectjson = "null",
  projectinfo = {};
let commitInfo = {};
let commituser = {};
let authorinfocard = {};
let authorinfoavatar = {};

const buttons = [
  { id: "open-zerocat-tab", text: "信息", onclick: () => updateZerocatTab() },
  { id: "save-button", text: "保存", onclick: () => openCommitDialog() },
  { id: "open-cloud-tool", text: "云变量", onclick: () => openCloudToolDialog() },
];

const cloudWsState = {
  socket: null,
  provider: null,
  projectId: null,
  username: "",
  wsUrl: "",
  status: "idle",
  variables: {},
  autoConnect: true,
  autoReconnect: true,
  manualDisconnect: false,
  retryTimer: null,
  retryCount: 0,
  wsCandidates: [],
  wsCandidateIndex: 0,
  globalListenersInstalled: false,
  pendingUpdates: {},
  handshakeSent: false,
};

function getQueryStringParameter(name) {
  return new URL(window.location.href).searchParams.get(name);
}

function getCurrentTime() {
  const now = new Date();
  return `${now.getHours()}:${now.getMinutes()}:${now.getSeconds()}`;
}

// 封装showSnackbar函数，确保mdui已加载
function showSnackbar(text) {
  if (window.UIManager) {
    UIManager.showSnackbar(text);
  } else {
    // 如果mdui未加载，使用console.log作为备选
    console.log(text);
  }
}

function getActiveVm() {
  return zcvm || window.vm || null;
}

function getCloudProjectId() {
  const fromInput = Number((cloudProjectIdInput?.value || "").trim());
  if (Number.isInteger(fromInput) && fromInput > 0) return fromInput;
  if (Number.isInteger(_pid) && _pid > 0) return _pid;
  const fromQuery = Number(getQueryStringParameter("id"));
  if (Number.isInteger(fromQuery) && fromQuery > 0) return fromQuery;
  return null;
}

function getCloudUsername() {
  const fromInput = (cloudUsernameInput?.value || "").trim();
  if (fromInput) return fromInput;
  return (localStorage.getItem("zc:cloud-username") || localStorage.getItem("zc:username") || "").trim();
}

function getCloudToken() {
  const localStrongsToken = window.localstrongs?.getItem?.("token") || window.localstrongs?.token;
  if (localStrongsToken) return localStrongsToken;
  return localStorage.getItem("token") || "";
}

function buildCloudWsUrlCandidates(token) {
  const endpointPath = "/scratch/cloud/ws";
  const sources = [
    ZCConfig.api.getPath(endpointPath),
    `${window.location.origin}${endpointPath}`,
    ZCConfig.api.url,
  ];
  const results = [];

  const addCandidate = (urlString) => {
    if (!urlString) return;
    if (!results.includes(urlString)) results.push(urlString);
  };

  for (const source of sources) {
    let base;
    try {
      base = new URL(source, window.location.origin);
    } catch (error) {
      continue;
    }
    base.pathname = endpointPath;
    base.hash = "";

    let protocolOrder = [];
    if (base.protocol === "wss:") protocolOrder = ["wss:", "ws:"];
    else if (base.protocol === "ws:") protocolOrder = ["ws:", "wss:"];
    else if (base.protocol === "https:") protocolOrder = ["wss:", "ws:"];
    else if (base.protocol === "http:") protocolOrder = ["ws:", "wss:"];
    else protocolOrder = window.location.protocol === "https:" ? ["wss:", "ws:"] : ["ws:", "wss:"];

    for (const protocol of protocolOrder) {
      const candidate = new URL(base.toString());
      candidate.protocol = protocol;
      candidate.search = "";
      if (token) candidate.searchParams.set("token", token);
      addCandidate(candidate.toString());
    }
  }

  return results;
}

function normalizeCloudWsUrl(urlLike, token) {
  try {
    const url = new URL(String(urlLike || ""), window.location.origin);
    if (url.protocol === "https:") url.protocol = "wss:";
    else if (url.protocol === "http:") url.protocol = "ws:";
    else if (url.protocol !== "ws:" && url.protocol !== "wss:") {
      url.protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
    }
    url.hash = "";
    if (token) url.searchParams.set("token", token);
    return url.toString();
  } catch (error) {
    return "";
  }
}

function appendCloudLog(text) {
  console.log(`[cloud ${getCurrentTime()}] ${text}`);
}

function setCloudConnectionStatus(status, detail = "") {
  cloudWsState.status = status;
  const statusText = detail ? `${status}: ${detail}` : status;
  if (cloudConnStatusInput) cloudConnStatusInput.value = statusText;
  appendCloudLog(`[status] ${statusText}`);
}

function collectVmCloudVariables() {
  const vm = getActiveVm();
  const stage = vm?.runtime?.getTargetForStage?.();
  const variables = Object.values(stage?.variables || {}).filter((item) => item && item.isCloud && typeof item.name === "string");
  const map = {};
  for (const item of variables) {
    map[item.name] = String(item.value ?? "");
  }
  return map;
}

function queueCloudUpdate(method, name, value) {
  const normalizedName = String(name || "").trim();
  if (!normalizedName) return false;
  if (cloudWsState.manualDisconnect) {
    cloudWsState.manualDisconnect = false;
  }

  if (method === "delete") {
    const existing = cloudWsState.pendingUpdates[normalizedName];
    if (existing && existing.method === "delete") return true;
    cloudWsState.pendingUpdates[normalizedName] = { method: "delete" };
  } else {
    const normalizedValue = String(value ?? "");
    const existing = cloudWsState.pendingUpdates[normalizedName];
    if (existing && existing.method === "set" && existing.value === normalizedValue) return true;
    cloudWsState.pendingUpdates[normalizedName] = { method: "set", value: normalizedValue };
  }

  cloudAutoConnectIfNeeded({ force: true });
  scheduleCloudReconnect("pending");
  return true;
}

function flushPendingCloudUpdates() {
  const socket = cloudWsState.socket;
  if (!socket || socket.readyState !== WebSocket.OPEN) return false;
  if (!cloudWsState.handshakeSent) {
    sendCloudHandshake();
  }
  const pending = cloudWsState.pendingUpdates;
  const names = Object.keys(pending);
  if (names.length === 0) return true;

  for (const name of names) {
    const item = pending[name];
    if (item.method === "delete") {
      sendCloudUpdate("delete", { name });
      appendCloudLog(`[out] delete ${name}`);
    } else if (item.method === "set") {
      sendCloudUpdate("set", { name, value: item.value });
      appendCloudLog(`[out] ${name} = ${item.value}`);
    }
  }

  cloudWsState.pendingUpdates = {};
  return true;
}

function areCloudMapsEqual(a, b) {
  const keysA = Object.keys(a);
  const keysB = Object.keys(b);
  if (keysA.length !== keysB.length) return false;
  for (const key of keysA) {
    if (!Object.prototype.hasOwnProperty.call(b, key) || a[key] !== b[key]) {
      return false;
    }
  }
  return true;
}

function renderCloudVariables() {
  if (!cloudVarsListContainer) return;
  const names = Object.keys(cloudWsState.variables).sort((a, b) => a.localeCompare(b, "zh-Hans-CN"));
  cloudVarsListContainer.innerHTML = "";
  if (cloudVarsCountInput) {
    cloudVarsCountInput.value = String(names.length);
  }

  if (names.length === 0) {
    const empty = document.createElement("div");
    empty.textContent = "当前没有云变量";
    empty.style.opacity = "0.75";
    empty.style.padding = "8px 0";
    cloudVarsListContainer.appendChild(empty);
    return;
  }

  for (const name of names) {
    const row = document.createElement("div");
    row.style.display = "grid";
    row.style.gridTemplateColumns = "minmax(180px, 1fr) minmax(180px, 1fr) auto";
    row.style.gap = "8px";
    row.style.marginBottom = "8px";

    const nameField = document.createElement("mdui-text-field");
    nameField.label = "变量名";
    nameField.value = name;
    nameField.readOnly = true;
    nameField.setAttribute("readonly", "");

    const valueField = document.createElement("mdui-text-field");
    valueField.label = "变量值";
    valueField.value = cloudWsState.variables[name] ?? "";
    valueField.setAttribute("data-cloud-name", name);
    valueField.addEventListener("keydown", (event) => {
      if (event.key === "Enter") {
        event.preventDefault();
        cloudSetVariableByName(name, valueField.value);
      }
    });

    const saveButton = document.createElement("mdui-button");
    saveButton.variant = "filled";
    saveButton.setAttribute("variant", "filled");
    saveButton.textContent = "保存";
    saveButton.addEventListener("click", () => {
      cloudSetVariableByName(name, valueField.value);
    });

    row.appendChild(nameField);
    row.appendChild(valueField);
    row.appendChild(saveButton);
    cloudVarsListContainer.appendChild(row);
  }
}

function refreshCloudVariablesFromVm({ forceRender = false } = {}) {
  const vmVariables = collectVmCloudVariables();
  if (forceRender || !areCloudMapsEqual(vmVariables, cloudWsState.variables)) {
    cloudWsState.variables = vmVariables;
    renderCloudVariables();
  }
}

function startCloudSyncTimer() {
  if (cloudSyncTimer) return;
  cloudSyncTimer = setInterval(() => {
    refreshCloudVariablesFromVm();
  }, 400);
}

function stopCloudSyncTimer() {
  if (!cloudSyncTimer) return;
  clearInterval(cloudSyncTimer);
  cloudSyncTimer = null;
}

function clearCloudRetryTimer() {
  if (!cloudWsState.retryTimer) return;
  clearTimeout(cloudWsState.retryTimer);
  cloudWsState.retryTimer = null;
}

function scheduleCloudReconnect(reason = "") {
  if (!cloudWsState.autoReconnect) return;
  if (cloudWsState.retryTimer) return;
  const socket = cloudWsState.socket;
  if (socket && (socket.readyState === WebSocket.CONNECTING || socket.readyState === WebSocket.OPEN)) {
    return;
  }

  cloudWsState.retryCount += 1;
  const exp = Math.min(cloudWsState.retryCount - 1, 6);
  const baseDelay = 1000 * Math.pow(2, Math.max(0, exp));
  const jitter = Math.floor(Math.random() * 500);
  const delayMs = Math.min(30000, baseDelay + jitter);
  setCloudConnectionStatus("retrying", `${delayMs}ms ${reason}`.trim());

  cloudWsState.retryTimer = setTimeout(() => {
    cloudWsState.retryTimer = null;
    connectCloudWs({ auto: true, silent: true });
  }, delayMs);
}

function cloudAutoConnectIfNeeded({ force = false } = {}) {
  if (!cloudWsState.autoConnect) return false;
  const socket = cloudWsState.socket;
  if (socket && (socket.readyState === WebSocket.CONNECTING || socket.readyState === WebSocket.OPEN || socket.readyState === WebSocket.CLOSING)) {
    return false;
  }
  return connectCloudWs({ auto: true, silent: true });
}

function installCloudGlobalListeners() {
  if (cloudWsState.globalListenersInstalled) return;
  cloudWsState.globalListenersInstalled = true;

  window.addEventListener("online", () => {
    cloudAutoConnectIfNeeded({ force: true });
  });

  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "visible") {
      cloudAutoConnectIfNeeded();
    }
  });
}

function parseCloudFrames(raw) {
  return String(raw || "")
    .split("\n")
    .map((line) => line.trim())
    .filter(Boolean)
    .map((line) => {
      try {
        return JSON.parse(line);
      } catch (error) {
        appendCloudLog(`[parse-error] ${line}`);
        return null;
      }
    })
    .filter(Boolean);
}

function sendCloudWsMessage(message) {
  const socket = cloudWsState.socket;
  if (!socket || socket.readyState !== WebSocket.OPEN) {
    appendCloudLog("[send] skipped, websocket not open");
    return false;
  }
  socket.send(JSON.stringify(message));
  return true;
}

function sendCloudHandshake() {
  if (!cloudWsState.projectId || !cloudWsState.username) return false;
  const ok = sendCloudWsMessage({
    method: "handshake",
    project_id: String(cloudWsState.projectId),
    user: cloudWsState.username,
  });
  if (ok) {
    cloudWsState.handshakeSent = true;
    appendCloudLog(`[handshake] project_id=${cloudWsState.projectId}, user=${cloudWsState.username}`);
  }
  return ok;
}

function sendCloudUpdate(method, payload) {
  if (!cloudWsState.projectId || !cloudWsState.username) {
    appendCloudLog("[send] skipped, project_id or user missing");
    return false;
  }
  return sendCloudWsMessage({
    method,
    project_id: String(cloudWsState.projectId),
    user: cloudWsState.username,
    ...payload,
  });
}

function createScratchCloudProvider() {
  return {
    createVariable: (name, value) => {
      const normalizedValue = String(value ?? "");
      cloudWsState.variables[name] = normalizedValue;
      renderCloudVariables();
      return sendCloudUpdate("create", { name, value: normalizedValue });
    },
    updateVariable: (name, value) => {
      const normalizedValue = String(value ?? "");
      cloudWsState.variables[name] = normalizedValue;
      renderCloudVariables();
      return sendCloudUpdate("set", { name, value: normalizedValue });
    },
    renameVariable: (oldName, newName) => {
      if (Object.prototype.hasOwnProperty.call(cloudWsState.variables, oldName)) {
        const value = cloudWsState.variables[oldName];
        delete cloudWsState.variables[oldName];
        cloudWsState.variables[newName] = value;
        renderCloudVariables();
      }
      return sendCloudUpdate("rename", { name: oldName, new_name: newName });
    },
    deleteVariable: (name) => {
      if (Object.prototype.hasOwnProperty.call(cloudWsState.variables, name)) {
        delete cloudWsState.variables[name];
        renderCloudVariables();
      }
      return sendCloudUpdate("delete", { name });
    },
    requestCloseConnection: () => disconnectCloudWs({ manual: false }),
  };
}

function handleCloudSocketMessage(data) {
  const vm = getActiveVm();
  for (const message of parseCloudFrames(data)) {
    if (message.method === "set" && typeof message.name === "string") {
      const value = message.value;
      vm?.postIOData?.("cloud", { varUpdate: { name: message.name, value } });
      const normalizedValue = String(value ?? "");
      if (cloudWsState.variables[message.name] !== normalizedValue) {
        cloudWsState.variables[message.name] = normalizedValue;
        renderCloudVariables();
      }
      appendCloudLog(`[in] ${message.name} = ${normalizedValue}`);
      continue;
    }
    appendCloudLog(`[in] ignored method=${message.method || "unknown"}`);
  }
}

function connectCloudWs(options = {}) {
  const silent = Boolean(options.silent);
  const shouldAutoRetry = Boolean(options.auto);
  const existingSocket = cloudWsState.socket;
  if (existingSocket && (existingSocket.readyState === WebSocket.CONNECTING || existingSocket.readyState === WebSocket.OPEN || existingSocket.readyState === WebSocket.CLOSING)) {
    if (!silent) {
      appendCloudLog("[connect] skipped, socket already active");
    }
    return false;
  }
  const vm = getActiveVm();
  if (!vm) {
    setCloudConnectionStatus("waiting_vm");
    if (!silent) showSnackbar("Scratch VM 尚未就绪");
    if (shouldAutoRetry) scheduleCloudReconnect("vm");
    return false;
  }

  const projectId = Number(options.projectId || getCloudProjectId());
  if (!Number.isInteger(projectId) || projectId <= 0) {
    setCloudConnectionStatus("waiting_project_id");
    if (!silent) showSnackbar("无效 project_id");
    if (shouldAutoRetry) scheduleCloudReconnect("project_id");
    return false;
  }

  const username = (options.username || getCloudUsername()).trim();
  if (!username) {
    setCloudConnectionStatus("waiting_user");
    if (!silent) showSnackbar("握手用户名不能为空");
    if (shouldAutoRetry) scheduleCloudReconnect("username");
    return false;
  }

  const token = String(options.token || getCloudToken() || "").trim();
  if (!token) {
    appendCloudLog("[auth] token missing, try anonymous handshake");
  }

  const directUrl = options.wsUrl ? normalizeCloudWsUrl(options.wsUrl, token) : "";
  const wsCandidates = directUrl ? [directUrl] : buildCloudWsUrlCandidates(token);
  if (wsCandidates.length === 0) {
    setCloudConnectionStatus("error", "no ws url candidates");
    if (shouldAutoRetry) scheduleCloudReconnect("no-candidate");
    return false;
  }

  clearCloudRetryTimer();
  cloudWsState.manualDisconnect = false;

  cloudWsState.wsCandidates = wsCandidates;
  const providedIndex = Number.isInteger(options.wsCandidateIndex)
    ? options.wsCandidateIndex
    : cloudWsState.wsCandidateIndex;
  const normalizedIndex = ((providedIndex % wsCandidates.length) + wsCandidates.length) % wsCandidates.length;
  cloudWsState.wsCandidateIndex = normalizedIndex;
  const wsUrl = wsCandidates[normalizedIndex];

  if (cloudWsState.socket && cloudWsState.socket.readyState !== WebSocket.CLOSED) {
    try {
      cloudWsState.socket.close(1000, "reconnect");
    } catch (error) {
      console.error("close old cloud ws error:", error);
    }
    cloudWsState.socket = null;
  }

  const provider = createScratchCloudProvider();
  vm.setCloudProvider(provider);
  cloudWsState.provider = provider;
  cloudWsState.projectId = projectId;
  cloudWsState.username = username;
  cloudWsState.wsUrl = wsUrl;
  cloudWsState.variables = collectVmCloudVariables();

  if (cloudProjectIdInput) cloudProjectIdInput.value = String(projectId);
  if (cloudUsernameInput) cloudUsernameInput.value = username;
  renderCloudVariables();

  localStorage.setItem("zc:cloud-username", username);

  let socket;
  try {
    socket = new WebSocket(wsUrl);
  } catch (error) {
    setCloudConnectionStatus("connect_error", String(error?.message || error));
    if (shouldAutoRetry) {
      cloudWsState.wsCandidateIndex = (cloudWsState.wsCandidateIndex + 1) % wsCandidates.length;
      scheduleCloudReconnect("constructor");
    }
    return false;
  }
  cloudWsState.socket = socket;
  setCloudConnectionStatus("connecting", `${wsUrl} [${normalizedIndex + 1}/${wsCandidates.length}]`);

  socket.addEventListener("open", () => {
    if (cloudWsState.socket !== socket) return;
    clearCloudRetryTimer();
    cloudWsState.retryCount = 0;
    setCloudConnectionStatus("open");
    cloudWsState.handshakeSent = false;
    sendCloudHandshake();
    setTimeout(() => {
      flushPendingCloudUpdates();
    }, 0);
  });

  socket.addEventListener("message", (event) => {
    if (cloudWsState.socket !== socket) return;
    handleCloudSocketMessage(event.data);
  });

  socket.addEventListener("close", (event) => {
    if (cloudWsState.socket !== socket) return;
    const detail = `code=${event.code}, reason=${event.reason || "-"}`;
    setCloudConnectionStatus("closed", detail);
    cloudWsState.socket = null;
    cloudWsState.handshakeSent = false;
    const currentVm = getActiveVm();
    if (currentVm && cloudWsState.provider) {
      currentVm.setCloudProvider(null);
    }
    cloudWsState.provider = null;
    if (!cloudWsState.manualDisconnect) {
      cloudWsState.wsCandidateIndex = (cloudWsState.wsCandidateIndex + 1) % cloudWsState.wsCandidates.length;
      scheduleCloudReconnect(`close:${event.code}`);
    }
  });

  socket.addEventListener("error", () => {
    if (cloudWsState.socket !== socket) return;
    setCloudConnectionStatus("error");
  });

  return true;
}

function disconnectCloudWs({ manual = true } = {}) {
  if (manual) {
    cloudWsState.retryCount = 0;
  }
  clearCloudRetryTimer();
  const socket = cloudWsState.socket;
  if (socket) {
    try {
      socket.close(1000, "client close");
    } catch (error) {
      console.error("close cloud ws error:", error);
    }
  }
  cloudWsState.socket = null;
  const vm = getActiveVm();
  if (vm && cloudWsState.provider) {
    vm.setCloudProvider(null);
  }
  cloudWsState.provider = null;
  setCloudConnectionStatus("disconnected");
}

function cloudConnect() {
  cloudWsState.manualDisconnect = false;
  connectCloudWs({ projectId: getCloudProjectId(), username: getCloudUsername(), auto: true });
}

function cloudDisconnect() {
  disconnectCloudWs({ manual: true });
}

function openCloudToolDialog() {
  if (!cloudDialog) {
    showSnackbar("云变量工具未初始化");
    return;
  }
  cloudDialog.open = true;
  refreshCloudVariablesFromVm({ forceRender: true });
  startCloudSyncTimer();
  cloudAutoConnectIfNeeded();
}

function cloudSetVariableByName(name, value) {
  const socket = cloudWsState.socket;
  if (!socket || socket.readyState !== WebSocket.OPEN) {
    const normalizedName = String(name || "").trim();
    if (!normalizedName) {
      showSnackbar("变量名不能为空");
      return;
    }
    const normalizedValue = String(value ?? "");
    queueCloudUpdate("set", normalizedName, normalizedValue);
    cloudWsState.variables[normalizedName] = normalizedValue;
    renderCloudVariables();
    appendCloudLog(`[out] queued ${normalizedName} = ${normalizedValue}`);
    showSnackbar("连接已断开，已加入队列并尝试重连");
    return;
  }

  const vm = getActiveVm();
  const cloudDevice = vm?.runtime?.ioDevices?.cloud;
  const normalizedName = String(name || "").trim();
  if (!normalizedName) {
    showSnackbar("变量名不能为空");
    return;
  }
  const normalizedValue = String(value ?? "");

  if (vm && cloudDevice?.requestUpdateVariable) {
    cloudDevice.requestUpdateVariable(normalizedName, normalizedValue);
  } else {
    sendCloudUpdate("set", { name: normalizedName, value: normalizedValue });
  }

  cloudWsState.variables[normalizedName] = normalizedValue;
  renderCloudVariables();
  appendCloudLog(`[out] ${normalizedName} = ${normalizedValue}`);
}

function cloudRefreshVariables() {
  refreshCloudVariablesFromVm({ forceRender: true });
}

window.CloudExternal = {
  connect: (options = {}) => connectCloudWs(options),
  disconnect: () => disconnectCloudWs({ manual: true }),
  set: (name, value) => cloudSetVariableByName(name, value),
  list: () => Object.keys(cloudWsState.variables).sort().map((name) => ({ name, value: cloudWsState.variables[name] })),
  refresh: () => cloudRefreshVariables(),
  autoConnect: () => {
    cloudWsState.manualDisconnect = false;
    return cloudAutoConnectIfNeeded({ force: true });
  },
  status: () => ({
    status: cloudWsState.status,
    projectId: cloudWsState.projectId,
    username: cloudWsState.username,
    wsUrl: cloudWsState.wsUrl,
    readyState: cloudWsState.socket ? cloudWsState.socket.readyState : null,
    retryCount: cloudWsState.retryCount,
    candidateIndex: cloudWsState.wsCandidateIndex,
    candidates: cloudWsState.wsCandidates,
  }),
};



function handleInvalidLogin(message) {
  if (window.UIManager) {
    UIManager.showAlert({
      headline: "需要登录",
      description: message || "请先登录后再进行操作",
      confirmText: "打开登录页面",
      cancelText: "取消",
      onConfirm: () => {
        const returnUrl = encodeURIComponent(window.location.href);
        window.open(
          `${ZCConfig.frontend.getPath(
            "/app/account/login"
          )}?return_url=${returnUrl}`,
          "_blank"
        );
      },
    });
  } else {
    if (confirm(`${message || "请先登录后再进行操作"}\n是否打开登录页面?`)) {
      const returnUrl = encodeURIComponent(window.location.href);
      window.open(
        `${ZCConfig.frontend.getPath(
          "/app/account/login"
        )}?return_url=${returnUrl}`,
        "_blank"
      );
    }
  }
  showLoginButton();
}

// 定义一个函数用于加载用户信息
async function loadUserInfo() {
  const token = localStorage.getItem("token");

  if (!token) {
    if (!isEmbed) showLoginButton();
    return;
  }

  // 从后端获取当前用户信息
  try {
    const result = await apiRequest({      url: `${ZCConfig.api.getPath("/user/me")}`,
      type: "GET",
    });

    if (result && result.data) {
      currentUserId = result.data.id;
      // 可选：缓存到 localStorage
      localStorage.setItem("zc:id", String(result.data.id));
      if (result.data.username) {
        localStorage.setItem("zc:cloud-username", result.data.username);
      } else if (result.data.zcusername) {
        localStorage.setItem("zc:cloud-username", result.data.zcusername);
      }
      if (result.data.display_name) {
        localStorage.setItem("zc:username", result.data.display_name);
      }
      cloudAutoConnectIfNeeded({ force: true });
    }
  } catch (error) {
    console.error("获取用户信息失败:", error);
    // Token 无效或过期，显示登录按钮
    if (error.status === 401 && !isEmbed) {
      showLoginButton();
    }
  }
}

function showLoginButton() {
  buttons.length = 0; // 清空按钮数组
  buttons.push({
    id: "login-button",
    text: "登录/注册",
    onclick: () => {
      // 添加当前URL作为return_url参数
      const returnUrl = encodeURIComponent(window.location.href);
      window.open(
        `${ZCConfig.frontend.getPath(
          "/app/account/login"
        )}?return_url=${returnUrl}`,
        "_blank"
      );
    },
  });
  renderButtons();
}

// 辅助函数：发送带 token 的 API 请求
function apiRequest(options) {
  const token = TokenManager.getToken();
  const headers = options.headers || {};

  if (token) {
    headers.Authorization = `Bearer ${token}`;
  }

  return $.ajax({
    ...options,
    headers,
  });
}

function renderButtons() {
  const zerocattool = document.getElementById("zerocattool");
  if (!zerocattool) return; // 确保元素存在

  zerocattool.innerHTML = ""; // 清空现有按钮
  buttons.forEach((button) => {
    const btnTemplate = zerocattool.cloneNode(true);
    btnTemplate.id = button.id;
    btnTemplate.innerHTML = button.text;
    if (button.onclick) btnTemplate.onclick = button.onclick;
    btnTemplate.style.display = "inline-block";
    zerocattool.parentNode.appendChild(btnTemplate);
  });
  zerocattool.style.display = "none";
}
window.renderButtons = renderButtons;

function setButton(id, text, onclick) {
  const button = document.getElementById(id);
  if (button) {
    button.innerText = text;
    button.onclick = onclick;
  }
}

// --- Refactored uploadProjectAssets ---
async function uploadProjectAssets() {
  try {
    const allAssetIds = zcvm.assets.map((asset) => asset.assetId);

    const checkResult = await apiRequest({
      url: `${ZCConfig.api.getPath("/assets/scratch/check")}`,
      type: "POST",
      dataType: "json",
      contentType: "application/json",
      data: JSON.stringify({ files: allAssetIds }),
    });

    const uploadedFiles = checkResult.data;
    const toUploadFiles = zcvm.assets.filter(
      (asset) => !uploadedFiles.includes(asset.assetId)
    );

    logText.value += `[${getCurrentTime()}] 需要上传 ${toUploadFiles.length} 个文件。
`;

    for (const asset of toUploadFiles) {
      try {
        const formData = new FormData();
        formData.append(
          "file",
          new Blob([asset.data], { type: asset.assetType.contentType }),
          `${asset.assetId}.${asset.dataFormat}`
        );

        await apiRequest({
          url: `${ZCConfig.api.getPath("/scratch/assets/" + asset.assetId + "." + asset.dataFormat)}`,
          type: "POST",
          data: formData,
          processData: false,
          contentType: false,
        });

        logText.value += `[${getCurrentTime()}] 文件上传成功: ${asset.assetId}.${asset.dataFormat}
`;
        asset.clean = true;
      } catch (error) {
        logText.value += `[${getCurrentTime()}] 文件上传失败: ${asset.assetId}.${asset.dataFormat}
Error: ${error.responseJSON?.message || error.statusText}
`;
      }
    }
    showSnackbar("媒体库保存完成");
  } catch (error) {
    console.error("Error checking or uploading assets:", error);
    showErrorAlert("媒体库保存失败", `错误: ${error.responseJSON?.message || error.statusText}`);
  }
}

// --- Refactored fetchProjectInfo ---
async function fetchProjectInfo() {
  if (_pid === 0 || !Number.isInteger(_pid)) return;

  updateLoadingDescription("正在获取项目详细信息...");
  try {
    const result = await apiRequest({
      url: `${ZCConfig.api.getPath("/scratch/projectinfo2")}?id=${_pid}`,
      type: "GET",
    });

    if (result.status == "404") {
      location.href = `${ZCConfig.frontend.getPath("/editor.html")}?msg=404`;
      return;
    }

    projectinfo = result;
    if (!isEmbed) {
      authorinfocard.headline = result.author.username;
      authorinfocard.description = result.author.zcusername;
      authorinfocard.onclick = () => window.open(`${ZCConfig.frontend.getPath("/")}${result.author.zcusername}`);
      authorinfocard.style.cursor = "pointer";
      authorinfoavatar.src = `${ZCConfig.s3.staticUrl}/assets/${result.author.profile.id.slice(0,2)}/${result.author.profile.id.slice(2,4)}/${result.author.profile.id}.webp`;
      zctab.headline = `${result.title} #${result.id}`;
      zctab.description = `${
        String(result.author.id) === String(currentUserId)
          ? "是你的作品"
          : "不是你的作品"
      }`;

      if (String(result.author.id) !== String(currentUserId)) {
        setButton("push-button", "改编", () => window.open(`${ZCConfig.frontend.getPath("/projects/")}${_pid}/fork`));
      }
    }
  } catch (error) {
    console.error("Error fetching project info:", error);
    showErrorAlert("获取项目信息失败", `错误: ${error.responseJSON?.message || error.statusText}`);
  }
}


function updateZerocatTab() {
  if (zctab) {
    zctab.open = true;
  }
}

// --- Refactored getZerocatUserInfo ---
async function getZerocatUserInfo(userid) {
  try {
    const result = await $.ajax({
      url: `${ZCConfig.api.getPath("/user/id/")}${userid}`,
      type: "GET",
    });
    return result.data;
  } catch (error) {
    console.error(`Failed to get user info for ${userid}:`, error);
    showErrorAlert("获取用户信息失败", `无法加载用户 ${userid} 的信息。`);
    return null;
  }
}


// 在initialize函数开始处添加检查URL参数中是否有token信息
function checkUrlForTokens() {
  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get("token");
  const refreshToken = urlParams.get("refreshToken");

  if (token) {
    // 保存从URL获取的token
    TokenManager.saveTokens(token, refreshToken);

    // 清除URL中的token参数
    const url = new URL(window.location.href);
    url.searchParams.delete("token");
    url.searchParams.delete("refreshToken");
    url.searchParams.delete("expires_at");
    window.history.replaceState({}, "", url);

    // 重新加载用户信息
    loadUserInfo();
    return true;
  }

  return false;
}

let isEmbed;
function initialize() {
  if (window.initialized) return; // 避免初始化两次
  window.initialized = true;

  // 检查URL中是否有token信息
  const tokenFromUrl = checkUrlForTokens();

  const urlParams = new URLSearchParams(window.location.search);
  isEmbed = urlParams.get("embed") === "true";

  if (!isEmbed) {
    try {
      const zerocatTabHTML = `
<mdui-dialog headline="作品" description="加载中" close-on-overlay-click id="zerocat-tab">
    <mdui-list>
        <mdui-list-subheader>作者</mdui-list-subheader>
        <mdui-list-item headline="作者信息" description="加载中" id="author-info" active rounded>
            <mdui-avatar slot="icon" src="" id="author-avatar"></mdui-avatar>
        </mdui-list-item>
        <mdui-list-subheader>当前提交</mdui-list-subheader>
        <mdui-list-item headline="提交信息" description="Supporting text" id="commit-info" rounded>
            <mdui-avatar slot="icon" src="" id="commit-avatar"></mdui-avatar>
        </mdui-list-item>
    </mdui-list>
    <br/>
    <mdui-button id="savestatic" onclick="uploadProjectAssets()">保存媒体库</mdui-button>
    <mdui-button onclick="openCommitDialog()">保存作品</mdui-button>
    <mdui-button onclick="logText.value = ''">清空log</mdui-button>
    <mdui-text-field autosize readonly  max-rows="5" variant="outlined" id="log-text"></mdui-text-field>
</mdui-dialog>
`;
      document.body.insertAdjacentHTML("beforeend", zerocatTabHTML);

      // 添加HTML创建提示框
      document.body.insertAdjacentHTML(
        "beforeend",
        `
<mdui-dialog
        headline="加载中"
        description="正在加载作品，请稍候..."
        close-on-overlay-click
        class="loading-dialog"
></mdui-dialog>
<mdui-dialog headline="提交作品" description="请输入提交信息" close-on-overlay-click id="commit-dialog">
    <mdui-text-field variant="outlined" label="提交信息" value="Update Project" id="commit-message"></mdui-text-field>
    <mdui-text-field variant="outlined" label="更多信息" rows id="commit-description"></mdui-text-field>
    <mdui-radio-group value="main">
        <mdui-radio value="main">提交给当前分支</mdui-radio>
        <mdui-radio value="pr">为此提交创建一个新分支</mdui-radio>
    </mdui-radio-group>
    <mdui-text-field variant="outlined" label="分支名称" value="main" id="branch-name"></mdui-text-field>
    <mdui-button onclick="commitProject()">提交</mdui-button>
</mdui-dialog>
<mdui-dialog headline="云变量工具" description="遵守标准协议，与 Scratch 云变量实时同步" close-on-overlay-click id="cloud-tool-dialog">
    <mdui-text-field variant="outlined" label="Project ID" id="cloud-project-id"></mdui-text-field>
    <mdui-text-field variant="outlined" label="Handshake User" id="cloud-username"></mdui-text-field>
    <mdui-text-field variant="outlined" label="连接状态" readonly id="cloud-conn-status"></mdui-text-field>
    <mdui-button onclick="cloudConnect()">连接后端 WS</mdui-button>
    <mdui-button onclick="cloudDisconnect()">断开连接</mdui-button>
    <mdui-button onclick="cloudRefreshVariables()">刷新变量列表</mdui-button>
    <div id="cloud-vars-list" style="max-height: 380px; overflow: auto; margin-top: 8px;"></div>
</mdui-dialog>
`
      );

      zctab = document.querySelector("#zerocat-tab");
      authorinfocard = document.querySelector("#author-info");
      authorinfoavatar = document.querySelector("#author-avatar");
      logText = document.querySelector("#log-text");
      cloudDialog = document.querySelector("#cloud-tool-dialog");
      cloudProjectIdInput = document.querySelector("#cloud-project-id");
      cloudUsernameInput = document.querySelector("#cloud-username");
      cloudConnStatusInput = document.querySelector("#cloud-conn-status");
      cloudVarsCountInput = document.querySelector("#cloud-vars-count");
      cloudVarsListContainer = document.querySelector("#cloud-vars-list");
      if (cloudProjectIdInput && _pid > 0) cloudProjectIdInput.value = String(_pid);
      if (cloudUsernameInput) cloudUsernameInput.value = getCloudUsername();
      setCloudConnectionStatus("idle");
      renderCloudVariables();
      if (cloudDialog) {
        cloudDialog.addEventListener("close", stopCloudSyncTimer);
        cloudDialog.addEventListener("closed", stopCloudSyncTimer);
      }

      renderButtons();
    } catch (error) {
      console.error("Error initializing non-embed mode:", error);
    }
  } else {
    document.body.insertAdjacentHTML(
      "beforeend",
      `
<mdui-dialog
        headline="加载中"
        description="正在加载作品，请稍候..."
        close-on-overlay-click
        class="loading-dialog"
        open
></mdui-dialog>
`
    );
  }

  const loadingDialog = document.querySelector(".loading-dialog");

  if (typeof ClipCCExtension !== "undefined") {
    zcvm = ClipCCExtension.api.getVmInstance();
    zcgui = ClipCCExtension.api.getGuiInstance();
  } else if (typeof window.vm !== "undefined") {
    zcvm = window.vm;
    zcgui = window.gui;
  } else {
    setTimeout(initialize, 100);
    return;
  }

  ResourceLoadTracker.install(zcvm);

  const msg = getQueryStringParameter("msg");
  if (msg) {
    if (msg == "404") alert("作品不存在");
    if (msg == "401") alert("未登录");
  }

  loadUserInfo();
  installCloudGlobalListeners();
  cloudAutoConnectIfNeeded();
  loadProject();
}

function zctabopen() {
  updateZerocatTab();
}

let isLoading = false;

// 更新loading对话框描述的函数
function updateLoadingDescription(description) {
  const loadingDialog = document.querySelector(".loading-dialog");
  if (loadingDialog) {
    loadingDialog.description = description;
  }
}

const ResourceLoadTracker = {
  active: false,
  total: 0,
  loaded: 0,
  failed: 0,
  wrapped: false,
  originalLoad: null,
  lastRenderAt: 0,
  install(vm) {
    if (this.wrapped) return;
    const storage = vm?.runtime?.storage;
    if (!storage || typeof storage.load !== "function") return;
    this.originalLoad = storage.load.bind(storage);
    const tracker = this;
    storage.load = function (...args) {
      const result = tracker.originalLoad(...args);
      if (!tracker.active) return result;
      return Promise.resolve(result)
        .then((asset) => {
          tracker.incrementLoaded(false);
          return asset;
        })
        .catch((error) => {
          tracker.incrementLoaded(true);
          throw error;
        });
    };
    this.wrapped = true;
  },
  start(total) {
    this.active = true;
    this.total = Math.max(0, Number(total) || 0);
    this.loaded = 0;
    this.failed = 0;
    this.render();
  },
  stop() {
    this.active = false;
  },
  incrementLoaded(failed) {
    if (!this.active) return;
    this.loaded += 1;
    if (failed) this.failed += 1;
    this.render();
  },
  render() {
    if (!this.active) return;
    const now = Date.now();
    if (now - this.lastRenderAt < 50) return;
    this.lastRenderAt = now;
    if (this.total <= 0) {
      updateLoadingDescription("正在加载资源...");
      return;
    }
    const percent = Math.min(100, Math.floor((this.loaded / this.total) * 100));
    const failText = this.failed > 0 ? `，失败 ${this.failed}` : "";
    updateLoadingDescription(`正在加载资源 ${this.loaded}/${this.total} (${percent}%)${failText}`);
  },
};

function countProjectAssets(projectData) {
  const targets = Array.isArray(projectData?.targets) ? projectData.targets : [];
  let total = 0;
  for (const target of targets) {
    if (Array.isArray(target?.costumes)) total += target.costumes.length;
    if (Array.isArray(target?.sounds)) total += target.sounds.length;
  }
  return total;
}

async function loadProject() {
  if (isLoading) return;
  isLoading = true;

  console.log("Loading project...");
  updateLoadingDescription("正在初始化项目加载...");

  const queryId = getQueryStringParameter("id");
  if (queryId) {
    _pid = Number(queryId);
    console.log(`Project ID from query: ${_pid}`);
    if (cloudProjectIdInput && Number.isInteger(_pid) && _pid > 0) {
      cloudProjectIdInput.value = String(_pid);
    }
    cloudAutoConnectIfNeeded({ force: true });
  }
  if (_pid === 0) {
    console.log("No project ID found, redirecting to new project page.");
    //window.location.href = `${CONFIG.API_HOST}/newproject`;
    isLoading = false;
    return;
  }

  console.log(`Fetching project info for ID: ${_pid}`);
  updateLoadingDescription("正在获取项目信息...");
  await fetchProjectInfo();

  if (zcvm) {
    await downloadAndLoadProject(_pid);
  } else {
    updateLoadingDescription("正在等待Scratch引擎初始化...");
    setTimeout(loadProject, 100);
  }
}

// --- Refactored downloadAndLoadProject & helpers ---
async function downloadAndLoadProject(pid) {
  console.log(`Downloading project with ID: ${pid}`);
  updateLoadingDescription("正在连接服务器获取项目数据...");

  const loadingDialog = document.querySelector(".loading-dialog");
  if (loadingDialog) {
    loadingDialog.open = true;
  }

  const branch = getQueryStringParameter("branch") || "main";
  const ref = getQueryStringParameter("ref") || "latest";

  try {
    const response = await apiRequest({
      url: `${ZCConfig.api.getPath("/project/")}${pid}/${branch}/${ref}`,
      type: "GET",
    });

    if (response.status === "error") {
      if (response.commit && response.commit.commit_message === "NoFirstCommit") {
        await handleUninitializedProject(pid);
      } else {
        showErrorAlert("加载失败", response.message, "关闭");
      }
      if (loadingDialog) loadingDialog.open = false;
      isLoading = false;
      return;
    }

    const { commit, accessFileToken } = response;
    commitInfo = commit;

    // 更新URL查询参数，将commit.id和branch写入URL
    if (commit) {
      const url = new URL(window.location.href);
      url.searchParams.set("ref", commit.id);
      url.searchParams.set("branch", branch);
      window.history.replaceState({}, "", url);
    }

    updateLoadingDescription("正在获取项目文件数据...");
    await updateCommitInfoUI(commit);

    const fileResponse = await apiRequest({
      url: `${ZCConfig.api.getPath("/project/files/")}${commit.commit_file}?content=true`,
      type: "GET",
      data: { accessFileToken },
    });

    updateLoadingDescription("正在解析项目数据...");
    // The response is the file content itself, not a JSON object containing it
    const projectData = JSON.parse(fileResponse);
    const totalAssets = countProjectAssets(projectData);
    ResourceLoadTracker.start(totalAssets);
    await zcvm.loadProject(projectData);
    ResourceLoadTracker.stop();

    console.log("Project loaded into VM successfully.");
    updateLoadingDescription("正在初始化Scratch引擎...");
    setTimeout(() => {
      if (loadingDialog) loadingDialog.open = false;
      zcvm.renderer.draw();
    }, 10);
    zcvm.renderer.draw();
    isLoading = false;

  } catch (error) {
    console.error("Error downloading or loading project:", error);
    ResourceLoadTracker.stop();
    if (loadingDialog) loadingDialog.open = false;
    isLoading = false;
    showErrorAlert(
      "加载失败",
      `作品加载失败: ${error.responseJSON?.message || error.statusText}`,
      "重新加载",
      () => window.location.reload()
    );
  }
}

async function handleUninitializedProject(pid) {
    updateLoadingDescription("检测到未初始化的项目，准备初始化...");
    const alertOptions = {
        headline: "作品未初始化",
        description: "你可以以Scratch模板初始化此作品",
        confirmText: "继续",
        onConfirm: async () => {
            updateLoadingDescription("正在初始化项目模板...");
            try {
                const response = await apiRequest({
                    url: `${ZCConfig.api.getPath("/project/edit/")}${pid}/init`,
                    type: "POST",
                });
                showSnackbar(response.message);
                updateLoadingDescription("项目初始化完成，重新加载...");
                await downloadAndLoadProject(pid);
            } catch (error) {
                console.error("Error initializing project:", error);
                showErrorAlert(
                    "初始化失败",
                    `作品初始化失败: ${error.responseJSON?.message || error.statusText}`,
                    "重新加载",
                    () => window.location.reload()
                );
            }
        },
    };

    if (window.UIManager) {
        UIManager.showAlert(alertOptions);
    } else {
        if (confirm(`${alertOptions.headline}: ${alertOptions.description}`)) {
            await alertOptions.onConfirm();
        }
    }
}

async function updateCommitInfoUI(commit) {
    if (isEmbed) return;
    try {
        const commitDate = new Date(commit.commit_date).toLocaleString();
        const commitInfoList = document.getElementById("commit-info");
        if (commitInfoList) {
            commitInfoList.headline = commit.commit_message;
            const commitInfoAvatar = document.getElementById("commit-avatar");
            const commitUser = await getZerocatUserInfo(commit.author_id);
            if (commitInfoAvatar && commitUser && commitUser.images) {
                commitInfoAvatar.src = `${ZCConfig.s3.staticUrl}/${commitUser.images}`;
            }
            if(commitUser) {
                commitInfoList.description = `${commitUser.display_name} 于 ${commitDate}`;
            }
        }
    } catch (error) {
        console.error("Failed to update commit info UI", error);
    }
}


// 通用错误提示函数
function showErrorAlert(headline, description, confirmText, onConfirm) {
  const options = {
    headline,
    description,
    confirmText,
  };

  if (onConfirm) {
    options.onConfirm = onConfirm;
  }

  if (window.UIManager) {
    UIManager.showAlert(options);
  } else {
    if (confirm(`${headline}: ${description}`)) {
      if (onConfirm) onConfirm();
    }
  }
}

function openCommitDialog() {
  const commitDialog = document.getElementById("commit-dialog");
  const branchNameInput = document.getElementById("branch-name");
  if (!commitDialog || !branchNameInput) {
    console.error("提交对话框未初始化");
    showSnackbar("提交对话框未初始化");
    return;
  }

  const branchRadioGroup = document.querySelector("mdui-radio-group");
  if (!branchRadioGroup) {
    console.error("分支选择未初始化");
    showSnackbar("分支选择未初始化");
    return;
  }

  const currentBranch = getQueryStringParameter("branch") || "main";
  branchNameInput.value = currentBranch;
  branchNameInput.disabled = true; // Disable by default

  branchRadioGroup.addEventListener("change", (event) => {
    if (event.target.value === "pr") {
      const username = localStorage.getItem("zc:username") || 'user';
      const timestamp = Date.now();
      const newBranchName = `${username}-patch-${timestamp}`;
      branchNameInput.value = newBranchName;
      branchNameInput.disabled = false;

      // 更新URL的branch参数
      const url = new URL(window.location.href);
      url.searchParams.set("branch", newBranchName);
      window.history.replaceState({}, "", url);
    } else {
      branchNameInput.value = currentBranch;
      branchNameInput.disabled = true;

      // 恢复URL的branch参数为当前分支
      const url = new URL(window.location.href);
      url.searchParams.set("branch", currentBranch);
      window.history.replaceState({}, "", url);
    }
  });

  commitDialog.open = true;
}

// --- Refactored commitProject ---
async function commitProject() {
  const branchNameInput = document.getElementById("branch-name");
  const commitMessageInput = document.getElementById("commit-message");
  const commitDescriptionInput = document.getElementById("commit-description");

  if (!branchNameInput || !commitMessageInput || !commitDescriptionInput) {
    showErrorAlert("错误", "提交表单未完全加载", "关闭");
    return;
  }

  const branchName = branchNameInput.value;
  const commitMessage = commitMessageInput.value;
  const commitDescription = commitDescriptionInput.value;

  if (!commitMessage) {
    showErrorAlert("提交信息不能为空", "请输入提交信息", "关闭");
    return;
  }

  setButton("save-button", "保存中...", () => {});
  const commitDialog = document.getElementById("commit-dialog");
  if(commitDialog) commitDialog.open = false;


  try {
    await uploadProjectAssets();

    if (zcvm.runtime.isRunning) {
      zcvm.runtime.stopAll();
    }

    const currentProjectJson = zcvm.toJSON();
    if (projectjson === currentProjectJson) {
      showSnackbar("作品未修改");
      setButton("save-button", "保存", () => openCommitDialog());
      return;
    }

    if (String(projectinfo.author.id) !== String(currentUserId)) {
      showSnackbar("无权限");
      setButton("save-button", "无权限", () => {});
      return;
    }

    projectjson = currentProjectJson;

    const saveResponse = await apiRequest({
      url: `${ZCConfig.api.getPath("/project/savefile")}?json=true`,
      type: "post",
      data: projectjson,
      contentType: "application/json",
    });

    const newAccessFileToken = saveResponse.accessFileToken;

    const commitResponse = await apiRequest({
      url: `${ZCConfig.api.getPath("/project/commit/id/")}${_pid}`,
      type: "put",
      data: JSON.stringify({
        projectid: _pid,
        branch: branchName,
        accessFileToken: newAccessFileToken,
        message: commitMessage,
        commit_description: commitDescription,
      }),
      contentType: "application/json",
    });

    showSnackbar(commitResponse.message);

    setButton("save-button", "保存完成", () => openCommitDialog());
    if (logText) {
      logText.value += `[${getCurrentTime()}]保存完成
`;
    }

    // 更新URL参数
    const url = new URL(window.location.href);
    url.searchParams.set("branch", branchName);

    // 如果提交响应包含commit信息，则更新URL的commit参数
    if (commitResponse.commit && commitResponse.commit.commit_id) {
      url.searchParams.set("ref", commitResponse.commit.commit_id);
    } else if (commitResponse.commit_id) {
      url.searchParams.set("ref", commitResponse.commit_id);
    }

    window.history.replaceState({}, "", url);

  } catch (error) {
    console.error("Error committing project:", error);
    showErrorAlert("提交作品出错", `错误: ${error.responseJSON?.message || error.statusText}`, "关闭");
    setButton("save-button", "保存", () => openCommitDialog());
  }
}


function saveProject({ force = false } = {}) {
  setButton("save-button", "保存中", () => openCommitDialog());
  uploadProjectAssets();
  if (force) {
    showSnackbar("强制保存");
    commitProject();
  }
  if (zcvm.runtime.isRunning) {
    zcvm.runtime.stopAll();
  }
  if (projectjson == zcvm.toJSON()) {
    showSnackbar("作品未修改");
    setButton("save-button", "保存", () => openCommitDialog());
    return;
  }
  if (String(projectinfo.author.id) !== String(currentUserId)) {
    showSnackbar("无权限");
    setButton("save-button", "无权限", () => openCommitDialog());
    return;
  }
  projectjson = zcvm.toJSON();
  commitProject();
  showSnackbar("保存完成");
  setButton("save-button", "保存完成", () => openCommitDialog());

  if (logText) {
    logText.value += `[${getCurrentTime()}]保存完成
`;
  }
}

function openBase64ImageInNewTab() {
  if (!zcvm) return;
  zcvm.renderer.requestSnapshot((dataURI) => {
    const imgWindow = window.open("", "_blank");
    imgWindow.document.write('<img src="' + dataURI + '"/>');
  });
}

async function setProjectThumbnail() {
  if (!zcvm) return;
  try {
    const dataURI = await new Promise(resolve => zcvm.renderer.requestSnapshot(resolve));
    const blob = await (await fetch(dataURI)).blob();
    const formData = new FormData();
    formData.append("file", blob, "thumbnail.png");

    const response = await apiRequest({
      url: `${ZCConfig.api.getPath("/scratch/thumbnail/")}${_pid}`,
      method: "POST",
      data: formData,
      processData: false,
      contentType: false,
    });

    if (response.status === "success") {
      showSnackbar("封面设置成功");
    } else {
      showSnackbar(`封面设置失败: ${response.message}`);
    }
  } catch (error) {
    console.error("Error setting project thumbnail:", error);
    showSnackbar(`封面设置失败: ${error.responseJSON?.message || error.statusText}`);
  }
}


buttons.push({
  id: "set-thumbnail-button",
  text: "舞台截图设为封面",
  onclick: () => setProjectThumbnail(),
});
